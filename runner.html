<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Stickman ‚Äì Corsa realistica</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <style>
    :root{
      --bg:#0b0d12; --text:#e7ecf3; --panel:#151826; --accent:#7dd3fc;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Roboto,Arial}
    .wrap{min-height:100vh;display:flex;flex-direction:column}
    header{padding:10px 12px;display:flex;gap:12px;align-items:center;justify-content:space-between;background:linear-gradient(180deg,rgba(255,255,255,.05),transparent)}
    .brand{font-weight:700}
    .panel{padding:12px}
    .box{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px 12px}
    .row{display:flex;gap:12px;align-items:center}
    label{min-width:110px}
    input[type="range"]{width:100%;accent-color:var(--accent);touch-action:pan-y}
    .stat{font-variant-numeric:tabular-nums}
    canvas{width:100vw;height:62vh;display:block;touch-action:manipulation;background:linear-gradient(#0b0d12 65%, #090b10)}
    footer{padding:10px 12px;opacity:.7}
    @media (min-width:720px){ canvas{height:66vh} }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">üèÉ‚Äç‚ôÇÔ∏è Stickman ‚Äì corsa realistica</div>
    <div class="stat">Velocit√†: <span id="spdLbl">0</span> px/s</div>
  </header>

  <canvas id="game" width="900" height="560" aria-label="Stickman realistic running"></canvas>

  <div class="panel">
    <div class="box">
      <div class="row">
        <label for="speed">Velocit√†</label>
        <input id="speed" type="range" min="5" max="100" step="5">
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const LS_KEY = 'stickman.realrun.v1';
  const loadCfg = () => { try { return JSON.parse(localStorage.getItem(LS_KEY)) || {}; } catch { return {}; } };
  const saveCfg = (o) => localStorage.setItem(LS_KEY, JSON.stringify(o));

  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const speedInput = document.getElementById('speed');
  const spdLbl = document.getElementById('spdLbl');

  const cfg = Object.assign({ speedPx: 40 }, loadCfg());
  speedInput.value = cfg.speedPx;
  spdLbl.textContent = cfg.speedPx;

  function resizeCanvas(){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const w = Math.min(window.innerWidth, 1100);
    const h = Math.round(window.innerHeight * 0.62);
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    canvas.width = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);

  const world = {
    speedPx: cfg.speedPx,
    groundY: () => Math.round(canvas.height/(window.devicePixelRatio||1) - 90),
    stripeOffset: 0,
    parallax: 0,
  };

  speedInput.addEventListener('input', () => {
    world.speedPx = +speedInput.value;
    spdLbl.textContent = world.speedPx;
    saveCfg({ speedPx: world.speedPx });
  });

  const man = {
    hipX: 220,
    hipY: world.groundY() - 40,
    torso: 60, neck: 16, headR: 14,
    thigh: 34, shin: 36, foot: 8,
    upperArm: 28, foreArm: 26,
    cycle: 0, cadence: 2.6, duty: 0.38, bobAmp: 6, color: '#fff'
  };

  function updateTemporalParams(){
    const v = world.speedPx;
    strideLen = Math.max(40, Math.min(160, 0.9*v + 20));
    man.cadence = 1.6 + 0.8 * Math.log(1 + v/20);
  }
  let strideLen = 90;
  updateTemporalParams();

  const clamp = (a,b,c)=>Math.max(b,Math.min(c,a));
  const lerp = (a,b,t)=>a+(b-a)*t;
  const smoothstep = (t)=>t*t*(3-2*t);

  function legIK(hipX, hipY, targetX, targetY, L1, L2){
    const dx = targetX - hipX, dy = targetY - hipY;
    const d = Math.hypot(dx, dy);
    const dd = clamp(d, 1e-4, L1+L2-1e-4);
    const a = Math.acos(clamp((L1*L1 + dd*dd - L2*L2)/(2*L1*dd), -1, 1));
    const base = Math.atan2(dy, dx);
    const hipA = base - a;
    const kneeA = Math.PI - Math.acos(clamp((L1*L1 + L2*L2 - dd*dd)/(2*L1*L2), -1, 1));
    const kneeX = hipX + L1*Math.cos(hipA);
    const kneeY = hipY + L1*Math.sin(hipA);
    return { hipA, kneeA, kneeX, kneeY, footX:targetX, footY:targetY };
  }

  function armFK(shoulderX, shoulderY, shoulderA, elbowA, L1, L2){
    shoulderA += Math.PI/2;
    elbowA += Math.PI;
    const elbowX = shoulderX + L1*Math.cos(shoulderA);
    const elbowY = shoulderY + L1*Math.sin(shoulderA);
    const handX  = elbowX    + L2*Math.cos(shoulderA + elbowA);
    const handY  = elbowY    + L2*Math.sin(shoulderA + elbowA);
    return { elbowX, elbowY, handX, handY };
  }

  function footTarget(which, phase){
    const df = man.duty;
    const gy = world.groundY();
    const hipX = man.hipX;
    if (phase < df){
      const t = phase/df;
      const x0 = hipX + 0.5*strideLen;
      const x1 = hipX - 0.5*strideLen;
      const x = lerp(x0, x1, t);
      return {x, y: gy, stance:true, lift:0};
    } else {
      const t = (phase - df)/(1-df);
      const x = lerp(hipX - 0.5*strideLen, hipX + 0.5*strideLen, smoothstep(t));
      const arc = Math.sin(Math.PI*t);
      const lift = 10 + 14 * arc * (0.5 + world.speedPx/120);
      return {x, y: gy - lift, stance:false, lift};
    }
  }

  function armAngles(globalPhase, side){
    const shAmp = 25 * Math.PI/180;
    const elBase = 100 * Math.PI/180;
    const elAmp  = 20 * Math.PI/180;
    const shoulderA = (-shAmp) * Math.sin(2*Math.PI*globalPhase + (side?Math.PI:0));
    const elbowA    = elBase + elAmp * Math.sin(2*Math.PI*globalPhase + (side?0:Math.PI));
    const shoulderX = man.hipX;
    const shoulderY = man.hipY - man.torso; // attach at top of torso
    return { shoulderA, elbowA, shoulderX, shoulderY };
  }

  function drawBackground(){
    const w = canvas.width/(window.devicePixelRatio||1);
    const h = canvas.height/(window.devicePixelRatio||1);
    const g = ctx.createLinearGradient(0,0,0,h);
    g.addColorStop(0,'#0c1221');
    g.addColorStop(1,'#0a0d15');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);
    ctx.strokeStyle = 'rgba(125,211,252,0.35)';
    ctx.lineWidth = 3;
    ctx.beginPath(); ctx.moveTo(0, world.groundY()); ctx.lineTo(w, world.groundY()); ctx.stroke();
  }

  function drawStickman(){
    ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle=man.color; ctx.fillStyle=man.color;
    const bob = man.bobAmp * Math.sin(2*Math.PI*man.cycle);
    const hipX = man.hipX;
    const hipY = man.hipY + bob;
    const neckX = hipX;
    const neckY = hipY - man.torso;
    const headCX = neckX;
    const headCY = neckY - man.neck - man.headR;
    const rightPhase = man.cycle % 1;
    const leftPhase  = (man.cycle + 0.5) % 1;
    const rt = footTarget(0, rightPhase);
    const lt = footTarget(1, leftPhase);
    const R = legIK(hipX, hipY-10, rt.x, rt.y, man.thigh, man.shin);
    const L = legIK(hipX, hipY-10, lt.x, lt.y, man.thigh, man.shin);
    const Ra = armAngles(man.cycle, 0);
    const La = armAngles(man.cycle, 1);
    const Rarm = armFK(Ra.shoulderX, Ra.shoulderY, Ra.shoulderA, Ra.elbowA, man.upperArm, man.foreArm);
    const Larm = armFK(La.shoulderX, La.shoulderY, La.shoulderA, La.elbowA, man.upperArm, man.foreArm);
    ctx.lineWidth=4;
    ctx.beginPath(); ctx.moveTo(hipX, hipY-10); ctx.lineTo(R.kneeX, R.kneeY); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(R.kneeX, R.kneeY); ctx.lineTo(R.footX, R.footY); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(hipX, hipY-10); ctx.lineTo(L.kneeX, L.kneeY); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(L.kneeX, L.kneeY); ctx.lineTo(L.footX, L.footY); ctx.stroke();
    ctx.lineWidth=4;
    ctx.beginPath(); ctx.moveTo(hipX, hipY-10); ctx.lineTo(neckX, neckY); ctx.stroke();
    ctx.lineWidth=3.5;
    ctx.beginPath(); ctx.moveTo(Ra.shoulderX, Ra.shoulderY); ctx.lineTo(Rarm.elbowX, Rarm.elbowY); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(Rarm.elbowX, Rarm.elbowY); ctx.lineTo(Rarm.handX, Rarm.handY); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(La.shoulderX, La.shoulderY); ctx.lineTo(Larm.elbowX, Larm.elbowY); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(Larm.elbowX, Larm.elbowY); ctx.lineTo(Larm.handX, Larm.handY); ctx.stroke();
    ctx.lineWidth=3.5;
    ctx.beginPath(); ctx.arc(headCX, headCY, man.headR, 0, Math.PI*2); ctx.stroke();
    ctx.beginPath(); ctx.arc(headCX+5, headCY-2, 1.6, 0, Math.PI*2); ctx.fill();
  }

  let last = performance.now();
  function frame(now){
    const dt = Math.min(0.05, (now - last)/1000);
    last = now;
    updateTemporalParams();
    man.cycle = (man.cycle + man.cadence*dt) % 1;
    world.parallax += world.speedPx * dt;
    world.stripeOffset += world.speedPx * dt;
    man.hipY = world.groundY() - 40;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawBackground();
    drawStickman();
    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
  speedInput.addEventListener('touchstart', e=>e.stopPropagation(), {passive:true});
})();
</script>
</body>
</html>
