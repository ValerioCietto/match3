<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Simulatore Fiscal Drag & Mini Legge di Bilancio (IRPEF)</title>
  <style>
    :root{--bg:#0b0f14;--card:#121821;--ink:#eaf2ff;--muted:#a6b0c0;--accent:#5bb0ff;--ok:#4cd964;--warn:#ffcc00;--bad:#ff6363;}
    *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(11,15,20,.98),rgba(11,15,20,.9));backdrop-filter:blur(6px);border-bottom:1px solid #1c2430}
    .wrap{max-width:1100px;margin:0 auto;padding:12px}
    h1{font-size:1.2rem;margin:0 0 8px}
    .grid{display:grid;gap:12px}
    @media(min-width:800px){.grid{grid-template-columns:1.2fr .8fr}}
    .card{background:var(--card);border:1px solid #1b2430;border-radius:16px;padding:12px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    label{font-size:.9rem;color:var(--muted)}
    input[type="number"],input[type="text"]{background:#0d131b;border:1px solid #202a38;color:var(--ink);border-radius:10px;padding:8px 10px;min-width:90px}
    input[type="range"]{width:140px}
    button{background:#0d6efd;border:0;color:white;border-radius:12px;padding:10px 14px;font-weight:600}
    button.ghost{background:#0d131b;border:1px solid #283246}
    .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:.8rem;border:1px solid #2a354a;color:var(--muted)}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .kpi .box{background:#0e141d;border:1px solid #1d2635;border-radius:14px;padding:10px}
    .big{font-size:1.1rem;font-weight:800}
    canvas{width:100%;height:auto;background:#0e1520;border:1px solid #1a2332;border-radius:12px}
    .tbl{width:100%;border-collapse:collapse;font-size:.9rem}
    .tbl th,.tbl td{border-bottom:1px solid #1f2a3a;padding:8px}
    .muted{color:var(--muted)}
    .tag-ok{color:var(--ok)} .tag-warn{color:var(--warn)} .tag-bad{color:var(--bad)}
    .tiny{font-size:.8rem}
    .stickybar{display:flex;gap:8px;flex-wrap:wrap}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Simulatore Fiscal Drag &amp; Mini Legge di Bilancio — IRPEF Italia</h1>
    <div class="stickybar">
      <span class="pill">Aliquote 2025 di default • certezza 95%</span>
      <span class="pill">Distribuzione ISTAT/MEF sintetica • certezza 75%</span>
      <span class="pill">No tax area: 8.000 € (imposta 0) • certezza 90%</span>
    </div>
  </div>
</header>

<main class="wrap grid">
  <section class="card">
    <h2>Controlli</h2>
    <div class="row">
      <label>Inflazione %</label>
      <input id="inflation" type="number" step="0.1" value="5" />
      <button class="ghost" id="applyInfl">Applica</button>
      <button class="ghost" id="sterilize">Sterilizza fiscal drag (alza soglie di inflazione)</button>
      <span class="muted tiny">Sterilizzazione: t1 e t2 ↑ della stessa % di inflazione.</span>
    </div>

    <h3>Scaglioni IRPEF</h3>
    <div class="row">
      <label>No tax area (€)</label><input id="noTax" type="number" value="8000" disabled />
      <span class="pill">Reddito ≤ 8.000 € ⇒ imposta 0</span>
    </div>
    <div class="row">
      <label>Soglia 1 (€)</label><input id="t1" type="number" value="28000"/>
      <label>Aliquota 1 (%)</label><input id="r1" type="number" step="0.1" value="23"/>
    </div>
    <div class="row">
      <label>Soglia 2 (€)</label><input id="t2" type="number" value="50000"/>
      <label>Aliquota 2 (%)</label><input id="r2" type="number" step="0.1" value="35"/>
    </div>
    <div class="row">
      <label>Aliquota 3 (%)</label><input id="r3" type="number" step="0.1" value="43"/>
      <button id="set2026" class="ghost">Proposta 2026: 33% middle</button>
      <button id="reset" class="ghost">Reset 2025</button>
      <button id="save">Salva</button>
    </div>

    <h3>Dati redditi (ISTAT/MEF)</h3>
    <div class="row">
      <button id="importCsv" class="ghost">Import CSV</button>
      <button id="exportJson" class="ghost">Export JSON</button>
      <input id="file" type="file" accept=".csv,.json" />
      <span class="muted tiny">CSV: <span class="mono">min,max,percentuale</span> (percentuale in %)</span>
    </div>
  </section>

  <section class="card">
    <h2>Stima gettito</h2>
    <div class="kpi">
      <div class="box">
        <div class="muted tiny">Baseline (anno t)</div>
        <div id="kpiBase" class="big">—</div>
      </div>
      <div class="box">
        <div class="muted tiny">Dopo inflazione (t+1, senza riforme)</div>
        <div id="kpiInfl" class="big">—</div>
      </div>
      <div class="box">
        <div class="muted tiny">Dopo riforma (t+1)</div>
        <div id="kpiReform" class="big">—</div>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <span class="pill">Fiscal drag stimato: <span id="dragTag" class="tag-warn">—</span></span>
      <span class="pill">Imp. riforma vs inflazione: <span id="reformTag" class="tag-ok">—</span></span>
    </div>
  </section>

  <section class="card">
    <h2>Grafici</h2>
    <div class="row"><label>Zoom aliquote</label><input type="range" id="zoomRate" min="1" max="3" step="0.1" value="1"></div>
    <canvas id="chartRates" width="900" height="260"></canvas>
    <div style="height:10px"></div>
    <canvas id="chartRevenue" width="900" height="260"></canvas>
    <div style="height:10px"></div>
    <canvas id="chartIncome" width="900" height="260"></canvas>
  </section>

  <section class="card">
    <h2>Tabella scaglioni / esempi</h2>
    <table class="tbl" id="examples">
      <thead><tr><th>Reddito</th><th>Imposta baseline</th><th>Imposta t+1 (solo inflazione)</th><th>Imposta t+1 (riforma)</th></tr></thead>
      <tbody></tbody>
    </table>
    <p class="tiny muted">Esempi su redditi: 15k, 25k, 35k, 50k, 80k, 120k.</p>
  </section>

  <section class="card">
    <h2>Note</h2>
    <p class="tiny">La “no tax area” qui è modellata come tax=0 per redditi ≤ 8.000 € (semplificazione). La sterilizzazione alza t1 e t2 della % di inflazione impostata. Certezza modellazione semplificata: 85%.</p>
  </section>
</main>

<script>
/*
# Comando da terminale per avviare in locale:
#   python3 -m http.server 8000
# poi apri http://localhost:8000
*/

const fmtEUR = v => (isNaN(v)?'—':v.toLocaleString('it-IT',{style:'currency',currency:'EUR',maximumFractionDigits:0}));
const LSKEY='irpef-sim-2025-v2';

const state = {
  inflation: 5,
  noTaxArea: 8000,            // NEW: soglia no tax area
  t1: 28000, t2: 50000, r1: 23, r2: 35, r3: 43,
  dist: [
    [    0,  7500,  7.0],
    [ 7500, 10000,  5.0],
    [10000, 15000, 14.0],
    [15000, 20000, 16.0],
    [20000, 26000, 18.0],
    [26000, 35000, 17.0],
    [35000, 55000, 13.0],
    [55000, 75000,  5.0],
    [75000,100000,  3.0],
    [100000,200000, 1.7],
    [200000,9999999,0.3]
  ],
  taxpayers: 1_000_000,
  classMean: (min,max)=> (min+max)/2
};

// load LS
(function(){
  try{
    const s = JSON.parse(localStorage.getItem(LSKEY)||'null');
    if(s){ Object.assign(state,s); }
  }catch(e){}
  document.getElementById('inflation').value = state.inflation;
  document.getElementById('t1').value = state.t1;
  document.getElementById('t2').value = state.t2;
  document.getElementById('r1').value = state.r1;
  document.getElementById('r2').value = state.r2;
  document.getElementById('r3').value = state.r3;
  document.getElementById('noTax').value = state.noTaxArea;
})();

function saveLS(){ localStorage.setItem(LSKEY, JSON.stringify(state)); }

function taxDue(y, t1,t2,r1,r2,r3, noTax){
  if(y<=0) return 0;
  // NEW: no tax area — se reddito lordo <= soglia, imposta zero
  if(y<=noTax) return 0;

  let tax=0;
  if(y<=t1) return y*(r1/100);
  tax += t1*(r1/100);
  if(y<=t2){ tax += (y-t1)*(r2/100); return tax; }
  tax += (t2-t1)*(r2/100);
  tax += (y-t2)*(r3/100);
  return tax;
}

function totalsFor(brackets){
  const {t1,t2,r1,r2,r3} = brackets;
  let base=0, infl=0, reform=0;
  const inflMult = 1 + (state.inflation/100);

  for(const [min,max,p] of state.dist){
    const share = p/100;
    const heads = share*state.taxpayers;
    const yBase = state.classMean(min,max);
    const yInfl = yBase*inflMult;

    base   += heads * taxDue(yBase,  state.t1,state.t2,state.r1,state.r2,state.r3, state.noTaxArea);
    infl   += heads * taxDue(yInfl,  state.t1,state.t2,state.r1,state.r2,state.r3, state.noTaxArea);
    reform += heads * taxDue(yInfl,  t1,     t2,     r1,     r2,     r3,           state.noTaxArea);
  }
  return {base, infl, reform};
}

function readInputsToState(){
  state.inflation = Number(document.getElementById('inflation').value)||0;
  state.t1 = Number(document.getElementById('t1').value)||28000;
  state.t2 = Number(document.getElementById('t2').value)||50000;
  state.r1 = Number(document.getElementById('r1').value)||23;
  state.r2 = Number(document.getElementById('r2').value)||35;
  state.r3 = Number(document.getElementById('r3').value)||43;
}

function updateKPIs(){
  const res = totalsFor({t1:state.t1,t2:state.t2,r1:state.r1,r2:state.r2,r3:state.r3});
  document.getElementById('kpiBase').textContent = fmtEUR(res.base);
  document.getElementById('kpiInfl').textContent = fmtEUR(res.infl);
  document.getElementById('kpiReform').textContent = fmtEUR(res.reform);

  const drag = res.infl - res.base;
  const reformImpact = res.reform - res.infl;

  const dragTag = document.getElementById('dragTag');
  const reformTag = document.getElementById('reformTag');
  dragTag.textContent = (drag>=0?'+':'') + fmtEUR(drag);
  dragTag.className = 'tag-' + (drag>0?'warn':(drag<0?'ok':'muted'));
  reformTag.textContent = (reformImpact>=0?'+':'') + fmtEUR(reformImpact);
  reformTag.className = 'tag-' + (reformImpact>0?'bad':(reformImpact<0?'ok':'muted'));

  drawCharts(res);
  fillExamples();
}

function drawCharts(res){
  drawRates();
  drawRevenueBars(res);
  drawIncome();
}

function drawRates(){
  const c = document.getElementById('chartRates');
  const ctx = c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  const pad=30, w=c.width-2*pad, h=c.height-2*pad;
  const {t1,t2,r1,r2,r3,noTaxArea}=state;
  const maxX = Math.max(120000,t2*1.2);
  const maxY = Math.max(r3,45);
  const zy = Number(document.getElementById('zoomRate').value);

  const X = x => pad + (x/maxX)*(w);
  const Y = y => pad + h - (y/maxY)*h*zy;

  // 0% fino a noTaxArea
  ctx.strokeStyle='#a6b0c0'; ctx.lineWidth=3;
  ctx.beginPath();
  ctx.moveTo(X(0), Y(0)); ctx.lineTo(X(noTaxArea), Y(0)); ctx.stroke();

  // Scaglioni standard
  ctx.strokeStyle = '#5bb0ff'; ctx.lineWidth=3;
  ctx.beginPath();
  ctx.moveTo(X(noTaxArea), Y(r1));
  ctx.lineTo(X(t1), Y(r1));
  ctx.lineTo(X(t1), Y(r2));
  ctx.lineTo(X(t2), Y(r2));
  ctx.lineTo(X(t2), Y(r3));
  ctx.lineTo(X(maxX), Y(r3));
  ctx.stroke();

  // Assi
  ctx.strokeStyle='#273144'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(pad,pad); ctx.lineTo(pad,pad+h); ctx.lineTo(pad+w,pad+h); ctx.stroke();
  ctx.fillStyle='#a6b0c0'; ctx.font='12px system-ui';
  ctx.fillText('Aliquota % (0% fino a 8.000 €)',6,14);
  ctx.fillText('Reddito (€)', pad+w-80, pad+h+20);
}

function drawRevenueBars(res){
  const c = document.getElementById('chartRevenue');
  const ctx = c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  const pad=30, barW=80, gap=40;
  const vals=[res.base,res.infl,res.reform];
  const labels=['Baseline','Inflazione','Riforma'];
  const maxV = Math.max(...vals)*1.1;
  const startX = pad+30;
  for(let i=0;i<3;i++){
    const x = startX + i*(barW+gap);
    const h = (vals[i]/maxV)*(c.height-2*pad);
    ctx.fillStyle = i===2 ? '#4cd964' : (i===1 ? '#ffcc00' : '#5bb0ff');
    ctx.fillRect(x, c.height-pad-h, barW, h);
    ctx.fillStyle='#a6b0c0'; ctx.font='12px system-ui';
    ctx.fillText(labels[i], x-6, c.height-8);
    ctx.fillText(fmtEUR(vals[i]).replace('€','€ '), x-10, c.height-pad-h-6);
  }
  ctx.strokeStyle='#273144';
  ctx.beginPath(); ctx.moveTo(pad,pad); ctx.lineTo(pad,c.height-pad); ctx.lineTo(c.width-pad,c.height-pad); ctx.stroke();
}

function drawIncome(){
  const c = document.getElementById('chartIncome');
  const ctx = c.getContext('2d');
  ctx.clearRect(0,0,c.width,c.height);
  const pad=30, w=c.width-2*pad, h=c.height-2*pad;
  const maxX = 100000;
  const maxY = Math.max(...state.dist.map(d=>d[2]))*1.2;
  const X = x => pad + Math.min(x,maxX)/maxX*w;
  const Y = y => pad + h - (y/maxY)*h;

  ctx.strokeStyle='#5bb0ff'; ctx.lineWidth=2; ctx.beginPath();
  let started=false;
  for(const [min,max,p] of state.dist){
    const x1=X(min), x2=X(Math.min(max,maxX));
    const y=Y(p);
    if(!started){ ctx.moveTo(x1,y); started=true; }
    ctx.lineTo(x1,y); ctx.lineTo(x2,y);
  }
  ctx.stroke();

  ctx.strokeStyle='#273144'; ctx.beginPath(); ctx.moveTo(pad,pad); ctx.lineTo(pad,pad+h); ctx.lineTo(pad+w,pad+h); ctx.stroke();
  ctx.fillStyle='#a6b0c0'; ctx.font='12px system-ui';
  ctx.fillText('Distribuzione contribuenti (%) per classe reddito', pad+6, pad+12);
}

function fillExamples(){
  const tbody = document.querySelector('#examples tbody');
  tbody.innerHTML='';
  const incomes=[15000,25000,35000,50000,80000,120000];
  for(const y of incomes){
    const inflMult = 1 + (state.inflation/100);
    const base = taxDue(y,state.t1,state.t2,state.r1,state.r2,state.r3,state.noTaxArea);
    const infl = taxDue(y*inflMult,state.t1,state.t2,state.r1,state.r2,state.r3,state.noTaxArea);
    const reform = taxDue(y*inflMult,state.t1,state.t2,state.r1,state.r2,state.r3,state.noTaxArea);
    const b = {t1:Number(document.getElementById('t1').value),t2:Number(document.getElementById('t2').value),
               r1:Number(document.getElementById('r1').value),r2:Number(document.getElementById('r2').value),r3:Number(document.getElementById('r3').value)};
    const reform2 = taxDue(y*inflMult,b.t1,b.t2,b.r1,b.r2,b.r3,state.noTaxArea);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${fmtEUR(y)}</td><td>${fmtEUR(base)}</td><td>${fmtEUR(infl)}</td><td>${fmtEUR(reform2)}</td>`;
    tbody.appendChild(tr);
  }
}

// UI events
document.getElementById('applyInfl').onclick=()=>{ readInputsToState(); saveLS(); updateKPIs(); };
document.getElementById('zoomRate').oninput=()=> drawRates();
document.getElementById('save').onclick=()=>{ readInputsToState(); saveLS(); updateKPIs(); };
document.getElementById('reset').onclick=()=>{
  state.t1=28000; state.t2=50000; state.r1=23; state.r2=35; state.r3=43; saveLS();
  document.getElementById('t1').value=state.t1; document.getElementById('t2').value=state.t2;
  document.getElementById('r1').value=state.r1; document.getElementById('r2').value=state.r2; document.getElementById('r3').value=state.r3;
  updateKPIs();
};
document.getElementById('set2026').onclick=()=>{
  document.getElementById('r2').value=33;
  readInputsToState(); saveLS(); updateKPIs();
};
// NEW: Sterilizzazione fiscal drag — aumenta soglie del tasso di inflazione corrente
document.getElementById('sterilize').onclick=()=>{
  const infl = Number(document.getElementById('inflation').value)||0;
  const mult = 1 + infl/100;
  document.getElementById('t1').value = Math.round(Number(document.getElementById('t1').value)*mult);
  document.getElementById('t2').value = Math.round(Number(document.getElementById('t2').value)*mult);
  readInputsToState(); saveLS(); updateKPIs();
};

// Import/Export
document.getElementById('importCsv').onclick=()=> document.getElementById('file').click();
document.getElementById('file').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const text = await f.text();
  try{
    let arr;
    if(f.name.endsWith('.json')){
      arr = JSON.parse(text);
    }else{
      arr = text.trim().split(/\r?\n/).map(line=>{
        const [min,max,p]=line.split(',').map(x=>Number(x.trim()));
        if([min,max,p].some(isNaN)) throw new Error('CSV non valido');
        return [min,max,p];
      });
    }
    const sum = arr.reduce((s,a)=>s+a[2],0);
    if(sum<95 || sum>105) alert('Attenzione: le percentuali non sommano ~100 ('+sum.toFixed(2)+'%).');
    state.dist = arr; saveLS(); updateKPIs();
  }catch(err){
    alert('Errore import: '+err.message);
  } finally {
    e.target.value='';
  }
});

document.getElementById('exportJson').onclick=()=>{
  const blob = new Blob([JSON.stringify(state.dist,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='distribuzione_redditi.json'; a.click();
};

updateKPIs();
</script>
</body>
</html>