<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Shooter — Upgrades</title>
<style>
  :root{
    --bg:#0b0e13; --ink:#e6e6e6; --muted:#9aa3ad; --card:#10151f; --line:#1e2633; --accent:#35c3ff;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial}
  header{
    position:sticky; top:0; z-index:5; background:rgba(0,0,0,.35);
    border-bottom:1px solid var(--line); padding:12px max(12px, env(safe-area-inset-right)) 12px max(12px, env(safe-area-inset-left));
    display:flex; align-items:center; justify-content:space-between; backdrop-filter:blur(6px);
  }
  .title{font-weight:700; letter-spacing:.3px}
  .btn{
    display:inline-flex; align-items:center; justify-content:center;
    min-height:44px; padding:10px 14px; border-radius:12px;
    border:1px solid rgba(255,255,255,.15); background:rgba(255,255,255,.06);
    color:var(--ink); font-weight:600; text-decoration:none; user-select:none;
  }
  .btn:disabled{opacity:.5}
  main{max-width:820px; margin:0 auto; padding:16px 12px 32px}
  .money{ margin:12px 0 8px; font-size:14px; color:var(--muted); }
  .grid{ display:grid; gap:10px; grid-template-columns:1fr; }
  @media (min-width:760px){ .grid{ grid-template-columns:1fr 1fr; } }
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px;
    display:flex; flex-direction:column; gap:8px;
  }
  .row{display:flex; align-items:center; justify-content:space-between; gap:10px}
  .name{font-weight:700}
  .desc{font-size:13px; color:var(--muted)}
  .stat{font-size:13px; color:#cfd6df}
  .actions{display:flex; gap:8px; flex-wrap:wrap}
  .price{font-size:12px; color:#c8f0ff; padding:2px 6px; border:1px solid rgba(53,195,255,.3); border-radius:999px; background:rgba(53,195,255,.08)}
  .small{font-size:12px; padding:8px 10px; min-height:36px}
  footer{margin-top:18px; font-size:12px; color:var(--muted); text-align:center}
  select{ background:rgba(255,255,255,0.06); color:var(--ink); border:1px solid rgba(255,255,255,0.15); border-radius:10px; padding:6px 8px; }
</style>
</head>
<body>
  <header>
    <div class="title">Upgrades</div>
    <!-- Aggiornato: ritorno al gioco -->
    <a class="btn" href="/match3/shooter_upgrade_complete.html">Return to Game ↩</a>
  </header>

  <main>
    <div class="money" id="money">Money: §0</div>

    <section class="grid" id="upgradesGrid">
      <!-- Cards generate via JS -->
    </section>

    <footer>
      Changes are saved automatically in your browser (localStorage).
    </footer>
  </main>

<script>
(() => {
  // -------- Storage (coerente con il gioco) --------
  const LS_KEY = 'vscroll.shooter.v1';
  const defaults = {
    money: 0,
    timeSec: 0,
    "bomb unlocked": false,
    "bomb type": "none",
    "bomb types owned": { screen: false, smart: false }, // NEW
    "boost unlocked": false,
    "boost type": "none",
    "enemies unlocked": { basic: true, betterVisible: true },
    "level data": { level: 1, difficulty: 1, score: 0 },
    "bullet type": "round",
    "bullet number": 1,
    "bullet spread": 0,         // degrees (cap 45° in UI)
    "bullet fire rate": 0.5,    // shots/sec
    "spawn every": 1.2,         // seconds between spawns (let the game read this)
    "boss unlocked": false
  };

  function loadSave(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      let save = raw ? JSON.parse(raw) : {};
      save = { ...defaults, ...save };
      mirrorAll(save);
      localStorage.setItem(LS_KEY, JSON.stringify(save));
      return save;
    }catch(e){
      localStorage.setItem(LS_KEY, JSON.stringify(defaults));
      mirrorAll(defaults);
      return structuredClone(defaults);
    }
  }
  function mirrorAll(obj){
    for (const [k,v] of Object.entries(obj)){
      localStorage.setItem(k, typeof v === 'object' ? JSON.stringify(v) : String(v));
    }
  }
  function commit(partial){
    save = { ...save, ...partial };
    for (const [k,v] of Object.entries(partial)){
      localStorage.setItem(k, typeof v === 'object' ? JSON.stringify(v) : String(v));
    }
    localStorage.setItem(LS_KEY, JSON.stringify(save));
    refreshUI();
  }

  let save = loadSave();

  // -------- Pricing / progression (più dolci) --------
  // Fire rate: base 5, x1.15 per livello, +0.1 sps
  // Bullet number: base 10, x1.2 per livello, +1 bullet, NO max
  // Spread: lasciamo come prima (cap 45°, 8 * 1.35^lv)
  // More basic enemies (spawn every): base 40, x1.4 per livello, -0.1s (min 0.1s)

  const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
  const round = (n)=>Math.round(n);

  // Fire rate
  function fireRateLevelFromValue(v){ return Math.max(0, Math.round((v - 0.5)/0.1)); }
  function fireRateValueFromLevel(lv){ return 0.5 + lv*0.1; }
  function fireRateCost(level){ return round(5 * Math.pow(1.15, level)); }

  // Bullet number (no max)
  function bulletNumberLevelFromValue(v){ return Math.max(0, Math.floor(v - 1)); }
  function bulletNumberValueFromLevel(lv){ return 1 + lv; }
  function bulletNumberCost(level){ return round(10 * Math.pow(1.2, level)); }

  // Spread
  function spreadLevelFromValue(v){ return Math.max(0, Math.round(v / 5)); }
  function spreadValueFromLevel(lv){ return clamp(lv*5, 0, 45); }
  function spreadCost(level){ return round(8 * Math.pow(1.35, level)); }
  const spreadMaxLv = 9; // 9*5=45°

  // More basic enemies (spawn every)
  function spawnEveryLevelFromValue(v){ // base 1.2, -0.1 per level
    return Math.max(0, Math.round((1.2 - v) / 0.1));
  }
  function spawnEveryValueFromLevel(lv){ return clamp(1.2 - lv*0.1, 0.1, 99); }
  function spawnEveryCost(level){ return round(40 * Math.pow(1.4, level)); }

  // -------- UI Builders --------
  const grid = document.getElementById('upgradesGrid');
  const moneyEl = document.getElementById('money');
  const fmtMoney = (n)=>`§${(n|0)}`;

  function refreshUI(){
    moneyEl.textContent = `Money: ${fmtMoney(save.money||0)}`;
    grid.innerHTML = '';

    // FIRE RATE
    {
      const lv = fireRateLevelFromValue(save["bullet fire rate"]);
      const price = fireRateCost(lv);
      const nextVal = fireRateValueFromLevel(lv+1);
      grid.appendChild(elCard({
        name: 'Fire Rate',
        desc: 'Increase shots per second (+0.1 per level). Softer price curve.',
        stat: `Current: ${save["bullet fire rate"].toFixed(2)} sps`,
        price: fmtMoney(price),
        canBuy: (save.money||0) >= price,
        onBuy: () => commit({ "bullet fire rate": nextVal, money: (save.money||0) - price })
      }));
    }

    // BULLET NUMBER (no max)
    {
      const lv = bulletNumberLevelFromValue(save["bullet number"]);
      const price = bulletNumberCost(lv);
      const nextVal = bulletNumberValueFromLevel(lv+1);
      grid.appendChild(elCard({
        name: 'Bullet Number',
        desc: 'Add +1 parallel bullet per shot (no max). Cheaper scaling.',
        stat: `Current: ${save["bullet number"]}`,
        price: fmtMoney(price),
        canBuy: (save.money||0) >= price,
        onBuy: () => commit({ "bullet number": nextVal, money: (save.money||0) - price })
      }));
    }

    // BULLET SPREAD
    {
      const lv = spreadLevelFromValue(save["bullet spread"]);
      const capped = lv >= spreadMaxLv;
      const price = spreadCost(lv);
      const nextVal = spreadValueFromLevel(lv+1);
      grid.appendChild(elCard({
        name: 'Bullet Spread',
        desc: 'Wider cone (+5° per level, up to 45°).',
        stat: `Current: ${save["bullet spread"]}°`,
        price: capped ? 'MAX' : fmtMoney(price),
        canBuy: !capped && (save.money||0) >= price,
        onBuy: () => {
          if (capped) return;
          commit({ "bullet spread": nextVal, money: (save.money||0) - price });
        }
      }));
    }

    // MORE BASIC ENEMIES (spawnEvery -0.1s, min 0.1s)
    {
      const lv = spawnEveryLevelFromValue(save["spawn every"]);
      const nextVal = spawnEveryValueFromLevel(lv+1);
      const price = spawnEveryCost(lv);
      const minReached = save["spawn every"] <= 0.1 + 1e-9;
      grid.appendChild(elCard({
        name: 'More Basic Enemies',
        desc: 'Enemies spawn faster (spawnEvery -0.1s, min 0.1s). Expensive.',
        stat: `Current spawnEvery: ${save["spawn every"].toFixed(1)}s`,
        price: minReached ? 'MIN' : fmtMoney(price),
        canBuy: !minReached && (save.money||0) >= price,
        onBuy: () => {
          if (minReached) return;
          commit({ "spawn every": nextVal, money: (save.money||0) - price });
        }
      }));
    }

    // BOMB PURCHASES (separati) + TYPE CHOOSER
    {
      const owned = save["bomb types owned"] || { screen:false, smart:false };
      const unlocked = !!save["bomb unlocked"]; // sarà true se compra almeno un tipo
      const type = save["bomb type"] || 'none';

      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="row"><div class="name">Bomb</div> <div class="price">${unlocked ? 'Unlocked' : 'Locked'}</div></div>
        <div class="desc">Buy specific bomb types. A chooser appears once at least one type is owned.</div>
        <div class="row"><div class="stat">Owned: screen=${owned.screen ? '✓' : '✕'}, smart=${owned.smart ? '✓' : '✕'}</div><div class="actions"></div></div>
        <div class="row" id="bombChooserRow" style="display:none;">
          <div class="stat">Current type:</div>
          <div>
            <select id="bombTypeSelect">
              <option value="screen">screen</option>
              <option value="smart">smart</option>
            </select>
          </div>
        </div>
      `;
      const actions = card.querySelector('.actions');

      // Buy screen (50)
      const btnScreen = document.createElement('button');
      btnScreen.className = 'btn small';
      btnScreen.textContent = 'Buy Screen (§50)';
      btnScreen.disabled = owned.screen || (save.money||0) < 50;
      btnScreen.onclick = () => {
        const nextOwned = { ...owned, screen: true };
        commit({
          "bomb types owned": nextOwned,
          "bomb unlocked": true,
          "bomb type": nextOwned.screen ? "screen" : (nextOwned.smart ? "smart" : "none"),
          money: (save.money||0) - 50
        });
      };
      actions.appendChild(btnScreen);

      // Buy smart (80)
      const btnSmart = document.createElement('button');
      btnSmart.className = 'btn small';
      btnSmart.textContent = 'Buy Smart (§80)';
      btnSmart.disabled = owned.smart || (save.money||0) < 80;
      btnSmart.onclick = () => {
        const nextOwned = { ...owned, smart: true };
        commit({
          "bomb types owned": nextOwned,
          "bomb unlocked": true,
          "bomb type": nextOwned.smart ? "smart" : (nextOwned.screen ? "screen" : "none"),
          money: (save.money||0) - 80
        });
      };
      actions.appendChild(btnSmart);

      // Chooser visible only if any owned
      const chooserRow = card.querySelector('#bombChooserRow');
      if (owned.screen || owned.smart) {
        chooserRow.style.display = '';
        const sel = card.querySelector('#bombTypeSelect');
        sel.value = (type === 'smart' && owned.smart) ? 'smart' : 'screen';
        sel.onchange = () => {
          const val = sel.value;
          if ((val === 'screen' && owned.screen) || (val === 'smart' && owned.smart)) {
            commit({ "bomb type": val, "bomb unlocked": true });
          }
        };
      }

      grid.appendChild(card);
    }

    // NEW GAME PLUS
    {
      grid.appendChild(elCard({
        name: 'New Game Plus',
        desc: 'Restart without upgrades but begin with §1000000.',
        stat: `This will reset bullets, spread, fire rate, bombs/boosts, enemy visibility, spawn rate, score and level.`,
        price: fmtMoney(1000),
        canBuy: (save.money||0) >= 1000,
        onBuy: () => {
          // Keep timeSec, reset upgrades/progress, set money 1000000
          const keepTime = save.timeSec || 0;
          const fresh = {
            ...defaults,
            timeSec: keepTime,
            money: 1000000,
            "level data": { level: 1, difficulty: 1, score: 0 },
            "enemies unlocked": { basic: true, betterVisible: true },
            "bomb unlocked": false,
            "bomb type": "none",
            "bomb types owned": { screen:false, smart:false },
            "boost unlocked": false,
            "boost type": "none",
            "bullet number": 1,
            "bullet spread": 0,
            "bullet fire rate": 0.5,
            "spawn every": 1.2,
            "boss unlocked": false
          };
          mirrorAll(fresh);
          localStorage.setItem(LS_KEY, JSON.stringify(fresh));
          save = fresh;
          refreshUI();
          alert('New Game Plus activated! Upgrades reset, you received §1000000.');
        }
      }));
    }
  }

  function elCard({name, desc, stat, price, canBuy, onBuy}){
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="row"><div class="name">${name}</div><div class="price">${price}</div></div>
      <div class="desc">${desc}</div>
      <div class="row">
        <div class="stat">${stat}</div>
        <div class="actions"></div>
      </div>
    `;
    const actions = card.querySelector('.actions');
    const buy = document.createElement('button');
    buy.className = 'btn small';
    buy.textContent = 'Buy';
    buy.disabled = !canBuy;
    buy.onclick = onBuy;
    actions.appendChild(buy);
    return card;
  }

  // Initial UI
  refreshUI();

  // Debug helpers
  window.upg = {
    addMoney(n=10){ commit({ money: (save.money||0)+n }); },
    setMoney(n){ commit({ money: n }); },
    save: ()=>save
  };
})();
</script>
</body>
</html>